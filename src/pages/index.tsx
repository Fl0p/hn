import Head from "next/head";
import { BadgeCheckIcon, ChevronRightIcon } from "lucide-react";
import { Button } from "~/components/ui/button";
import {
  Item,
  ItemActions,
  ItemContent,
  ItemDescription,
  ItemMedia,
  ItemTitle,
} from "~/components/ui/item";

import { api } from "~/utils/api";
import Link from "next/link";
import { cn } from "~/utils";
import { formatDate } from "~/utils/format-date";
import { SubmissionStatus } from "generated/prisma";
import PacmanLoader from "react-spinners/PacmanLoader";
import { useRouter } from "next/router";

const order = [
  "INITIALIZED",
  "ANALYZED",
  "IN_PROGRESS",
  "PROLONGATED",
  "COMPLETED",
  "DECISION_MADE",
];

export default function Home() {
  const router = useRouter();
  const { data: submissions, isPending: isLoading } =
    api.post.getAll.useQuery();

  const submissionsSorted = submissions?.sort(
    (a, b) => order.indexOf(a.status) - order.indexOf(b.status),
  );

  return (
    <>
      <Head>
        <title>DecyZen</title>
        <meta name="description" content="Generated by create-t3-app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <header className="body-lg-bold relative flex items-center justify-between gap-4 p-4">
        <Link href="/">Hacknation 2025</Link>
        {isLoading && (
          <PacmanLoader size={12} className="absolute right-12 -bottom-8" />
        )}
        <div className="flex items-center gap-4">
          <Button
            size="sm"
            className={cn({ hidden: router.asPath === "/case/new" })}
            asChild
          >
            <Link href="/case/new">Dodaj sprawę</Link>
          </Button>
          <Button size="sm">Archiwum</Button>
          <Button size="sm">Ustawienia</Button>
        </div>
      </header>
      <main className="flex min-h-[calc(100vh-64px)] flex-col items-center justify-center">
        <div className="container flex flex-col items-center justify-center gap-12 px-4 py-16">
          <div className="w-3/4 max-w-3xl">
            <label
              htmlFor="case-search"
              className="mb-2 block text-xl font-semibold text-white"
            >
              Wyszukiwanie sprawy
            </label>
            <input
              id="case-search"
              type="text"
              placeholder="Wprowadź numer sprawy lub słowa kluczowe..."
              className="w-full rounded-lg border border-gray-300 bg-white px-4 py-3 text-gray-900 focus:border-purple-500 focus:ring-2 focus:ring-purple-500 focus:outline-none"
            />
          </div>
          <div className="flex w-full flex-col items-center text-2xl text-white">
            {submissionsSorted?.length
              ? submissionsSorted.map((submission) => {
                  const initDate = new Date(
                    submission?.initDate ?? "2000-01-01",
                  );
                  const deadline = new Date(initDate);

                  // add 30 days
                  deadline.setDate(deadline.getDate() + 30);
                  return (
                    <Item
                      variant="outline"
                      size="sm"
                      asChild
                      key={submission.id}
                      className="m-3 w-1/2"
                    >
                      <Link href={`/submission/${submission.id}`}>
                        <ItemMedia>
                          <BadgeCheckIcon className="size-5" />
                        </ItemMedia>
                        <ItemContent className="flex flex-row gap-2">
                          <ItemTitle>{submission.caseNumber}</ItemTitle>
                          <ItemDescription className="flex flex-row gap-2">
                            Status: {submission.status}
                            <div
                              className={cn("text-[#009900]", {
                                "text-[#ff0000]":
                                  deadline.getTime() < new Date().getTime() &&
                                  submission.status !==
                                    SubmissionStatus.DECISION_MADE,
                                "text-[#FFD700]":
                                  submission.status ===
                                  SubmissionStatus.DECISION_MADE,
                              })}
                            >
                              {formatDate(deadline)}
                            </div>
                          </ItemDescription>
                        </ItemContent>
                        <ItemActions>
                          <ChevronRightIcon className="size-4" />
                        </ItemActions>
                      </Link>
                    </Item>
                  );
                })
              : "Nothing had been submitted yet."}
          </div>
        </div>
      </main>
    </>
  );
}
